<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=author content><title>AES GCM Stream Spec</title><link href=/css/bootstrap.css rel=stylesheet><link href=/css/markdown.css rel=stylesheet><link href=/css/katex.min.css rel=stylesheet><link href=/css/iceberg-theme.css rel=stylesheet><link href=/font-awesome-4.7.0/css/font-awesome.min.css rel=stylesheet type=text/css><link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel=stylesheet type=text/css><link href=/css/termynal.css rel=stylesheet></head><body><head><script>function addAnchor(e){e.insertAdjacentHTML("beforeend",`<a href="#${e.id}" class="anchortag" ariaLabel="Anchor"> üîó </a>`)}document.addEventListener("DOMContentLoaded",function(){var e=document.querySelectorAll("h1[id], h2[id], h3[id], h4[id]");e&&e.forEach(addAnchor)})</script></head><nav class="navbar navbar-default" role=navigation><topsection><div class=navbar-fixed-top><div><button type=button class=navbar-toggle data-toggle=collapse data-target=div.sidebar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class="page-scroll navbar-brand" href=https://iceberg.apache.org/><img class=top-navbar-logo src=https://iceberg.apache.org//img/iceberg-logo-icon.png> Apache Iceberg</a></div><div><input type=search class=form-control id=search-input placeholder=Search... maxlength=64 data-hotkeys=s/></div><div class=versions-dropdown><span>1.2.1</span> <i class="fa fa-chevron-down"></i><div class=versions-dropdown-content><ul><li class=versions-dropdown-selection><a href=/docs/latest>latest</a></li><li class=versions-dropdown-selection><a href=/docs/1.2.1>1.2.1</a></li><li class=versions-dropdown-selection><a href=/docs/1.2.0>1.2.0</a></li><li class=versions-dropdown-selection><a href=/docs/1.1.0>1.1.0</a></li><li class=versions-dropdown-selection><a href=/docs/1.0.0>1.0.0</a></li><li class=versions-dropdown-selection><a href=/docs/0.14.1>0.14.1</a></li><li class=versions-dropdown-selection><a href=/docs/0.14.0>0.14.0</a></li><li class=versions-dropdown-selection><a href=/docs/0.13.2>0.13.2</a></li><li class=versions-dropdown-selection><a href=/docs/0.13.1>0.13.1</a></li><li class=versions-dropdown-selection><a href=/docs/0.13.0>0.13.0</a></li><li class=versions-dropdown-selection><a href=/docs/0.12.1>0.12.1</a></li></ul></div></div></div><div class="navbar-menu-fixed-top navbar-pages-group"><div class=topnav-page-selection><a href=/spark-quickstart>Quickstart</a></div class="topnav-page-selection"><div class=topnav-page-selection><a href=/docs/latest>Docs</a></div class="topnav-page-selection"><div class=topnav-page-selection><a href=/releases>Releases</a></div class="topnav-page-selection"><div class=topnav-page-selection><a href=/roadmap>Roadmap</a></div class="topnav-page-selection"><div class=topnav-page-selection><a href=/blogs>Blogs</a></div class="topnav-page-selection"><div class=topnav-page-selection><a href=/talks>Talks</a></div class="topnav-page-selection"><div class=topnav-page-selection><a href=/vendors>Vendors</a></div class="topnav-page-selection"><div class=versions-dropdown><div class=topnav-page-selection><a href>Project</a> <i class="fa fa-chevron-down"></i></div class="topnav-page-selection"><div class=versions-dropdown-content><ul><li class=topnav-page-selection><a href=/community>Join</a></li class="topnav-page-selection"><li class=topnav-page-selection><a href=/spec>Spec</a></li class="topnav-page-selection"><li class=topnav-page-selection><a href=/view-spec>View Spec</a></li class="topnav-page-selection"><li class=topnav-page-selection><a href=/puffin-spec>Puffin Spec</a></li class="topnav-page-selection"><li class=topnav-page-selection><a href=/multi-engine-support>Multi-Engine Support</a></li class="topnav-page-selection"><li class=topnav-page-selection><a href=/how-to-release>How To Release</a></li class="topnav-page-selection"><li class=topnav-page-selection><a href=/terms>Terms</a></li class="topnav-page-selection"></ul></div></div><div class=versions-dropdown><div class=topnav-page-selection><a href>ASF</a> <i class="fa fa-chevron-down"></i></div class="topnav-page-selection"><div class=versions-dropdown-content><ul><li class=topnav-page-selection><a target=_blank href=https://www.apache.org/foundation/sponsorship.html>Donate</a></li class="topnav-page-selection"><li class=topnav-page-selection><a target=_blank href=https://www.apache.org/events/current-event.html>Events</a></li class="topnav-page-selection"><li class=topnav-page-selection><a target=_blank href=https://www.apache.org/licenses/>License</a></li class="topnav-page-selection"><li class=topnav-page-selection><a target=_blank href=https://www.apache.org/security/>Security</a></li class="topnav-page-selection"><li class=topnav-page-selection><a target=_blank href=https://www.apache.org/foundation/thanks.html>Sponsors</a></li class="topnav-page-selection"></ul></div></div><div class=topnav-page-selection><a href=https://github.com/apache/iceberg target=_blank><img src=https://iceberg.apache.org//img/GitHub-Mark.png target=_blank class=top-navbar-logo></a></div><div class=topnav-page-selection><a href=https://join.slack.com/t/apache-iceberg/shared_invite/zt-1oj35f7yc-wuTEhvkiqjGLje83B7rG8A target=_blank><img src=https://iceberg.apache.org//img/Slack_Mark_Web.png target=_blank class=top-navbar-logo></a></div></div></topsection></nav><section><div id=search-results-container><ul id=search-results></ul></div></section><body dir=" ltr"><section><div class="grid-container toc-only"><div id=content class=markdown-body><div class=margin-for-toc><h1 id=aes-gcm-stream-file-format-extension>AES GCM Stream file format extension</h1><h2 id=background-and-motivation>Background and Motivation</h2><p>Iceberg supports a number of data file formats. Two of these formats (Parquet and ORC) have built-in encryption capabilities, that allow to protect sensitive information in the data files. However, besides the data files, Iceberg tables also have metadata files, that keep sensitive information too (e.g., min/max values in manifest files, or bloom filter bitsets in puffin files). Metadata file formats (AVRO, JSON, Puffin) don&rsquo;t have encryption support.</p><p>Moreover, with the exception of Parquet, no Iceberg data or metadata file format supports integrity verification, required for end-to-end tamper proofing of Iceberg tables.</p><p>This document specifies details of a simple file format extension that adds encryption and tamper-proofing to any existing file format.</p><h2 id=goals>Goals</h2><ul><li>Metadata encryption: enable encryption of manifests, manifest lists, snapshots and stats.</li><li>Avro data encryption: enable encryption of data files in tables that use the Avro format.</li><li>Support read splitting: enable seekable decrypting streams that can be used with splittable formats like Avro.</li><li>Tamper proofing of Iceberg data and metadata files.</li></ul><h2 id=overview>Overview</h2><p>The output stream, produced by a metadata or data writer, is split into equal-size blocks (plus last block that can be shorter). Each block is enciphered (encrypted/signed) with a given encryption key, and stored in a file in the AES GCM Stream format. Upon reading, the stored cipherblocks are verified for integrity; then decrypted and passed to metadata or data readers.</p><h2 id=encryption-algorithm>Encryption algorithm</h2><p>AES GCM Stream uses the standard AEG GCM cipher, and supports all AES key sizes: 128, 192 and 256 bits.</p><p>AES GCM is an authenticated encryption. Besides data confidentiality (encryption), it supports two levels of integrity verification (authentication): of the data (default), and of the data combined with an optional AAD (‚Äúadditional authenticated data‚Äù). An AAD is a free text to be authenticated, together with the data. The structure of AES GCM Stream AADs is described below.</p><p>AES GCM requires a unique vector to be provided for each encrypted block. In this document, the unique input to GCM encryption is called nonce (‚Äúnumber used once‚Äù). AES GCM Stream encryption uses the RBG-based (random bit generator) nonce construction as defined in the section 8.2.2 of the NIST SP 800-38D document. For each encrypted block, AES GCM Stream generates a unique nonce with a length of 12 bytes (96 bits).</p><h2 id=format-specification>Format specification</h2><h3 id=file-structure>File structure</h3><p>The AES GCM Stream files have the following structure</p><pre tabindex=0><code>Magic BlockLength CipherBlock‚ÇÅ CipherBlock‚ÇÇ ... CipherBlock‚Çô
</code></pre><p>where</p><ul><li><code>Magic</code> is four bytes 0x41, 0x47, 0x53, 0x31 (&ldquo;AGS1&rdquo;, short for: AES GCM Stream, version 1)</li><li><code>BlockLength</code> is four bytes (little endian) integer keeping the length of the equal-size split blocks before encryption. The length is specified in bytes.</li><li><code>CipherBlock·µ¢</code> is the i-th enciphered block in the file, with the structure defined below.</li></ul><h3 id=cipher-block-structure>Cipher Block structure</h3><p>Cipher blocks have the following structure</p><table><thead><tr><th>nonce</th><th>ciphertext</th><th>tag</th></tr></thead></table><p>where</p><ul><li><code>nonce</code> is the AES GCM nonce, with a length of 12 bytes.</li><li><code>ciphertext</code> is the encrypted block. Its length is identical to the length of the block before encryption (&ldquo;plaintext&rdquo;). The length of all plaintext blocks, except the last, is <code>BlockLength</code> bytes. The last block has a non-zero length &lt;= <code>BlockLength</code>.</li><li><code>tag</code> is the AES GCM tag, with a length of 16 bytes.</li></ul><p>AES GCM Stream encrypts all blocks by the GCM cipher, without padding. The AES GCM cipher must be implemented by a cryptographic provider according to the NIST SP 800-38D specification. In AES GCM Stream, an input to the GCM cipher is an AES encryption key, a nonce, a plaintext and an AAD (described below). The output is a ciphertext with the length equal to that of plaintext, and a 16-byte authentication tag used to verify the ciphertext and AAD integrity.</p><h3 id=additional-authenticated-data>Additional Authenticated Data</h3><p>The AES GCM cipher protects against byte replacement inside a ciphertext block - but, without an AAD, it can&rsquo;t prevent replacement of one ciphertext block with another (encrypted with the same key). AES GCM Stream leverages AADs to protect against swapping ciphertext blocks inside a file or between files. AES GCM Stream can also protect against swapping full files - for example, replacement of a metadata file with an old version. AADs are built to reflects the identity of a file and of the blocks inside the file.</p><p>AES GCM Stream constructs a block AAD from two components: an AAD prefix - a string provided by Iceberg for the file (with the file ID), and an AAD suffix - the block sequence number in the file, as an int in a 4-byte little-endian form. The block AAD is a direct concatenation of the prefix and suffix parts.</p></div><div id=toc class=markdown-body><div id=full><nav id=TableOfContents><ul><li><a href=#background-and-motivation>Background and Motivation</a></li><li><a href=#goals>Goals</a></li><li><a href=#overview>Overview</a></li><li><a href=#encryption-algorithm>Encryption algorithm</a></li><li><a href=#format-specification>Format specification</a><ul><li><a href=#file-structure>File structure</a></li><li><a href=#cipher-block-structure>Cipher Block structure</a></li><li><a href=#additional-authenticated-data>Additional Authenticated Data</a></li></ul></li></ul></nav></div></div></div></div></section></body><script src=https://iceberg.apache.org//js/jquery-1.11.0.js></script>
<script src=https://iceberg.apache.org//js/jquery.easing.min.js></script>
<script type=text/javascript src=https://iceberg.apache.org//js/search.js></script>
<script src=https://iceberg.apache.org//js/bootstrap.min.js></script>
<script src=https://iceberg.apache.org//js/iceberg-theme.js></script></html>